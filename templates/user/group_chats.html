{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href= "{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <link rel='stylesheet' href='//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.9.0/bootstrap-table.min.css'>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <title>Chat Page</title>
    <!-- Include necessary CSS styles here -->
    <style>
        /* Container for the chat section */
        #unreadMessagesCount, #downScrollButton {
            background-color: #f44336; /* Red background for visibility */
            color: white; /* White text for contrast */
            padding: 5px 10px; /* Padding for spacing */
            border-radius: 5px; /* Rounded corners */
            font-weight: bold; /* Bold text */
            display: inline-block; /* Keep it inline with other elements */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* Add a subtle shadow */
            position: relative; /* Relative positioning */
            z-index: 1; /* Ensure it's on top of overlapping elements */
        }
       

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 800px; /* Adjust as needed */
            margin: 0 auto; /* Center the container */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* Enhanced shadow for depth */
        }

        /* Styles for chat messages display */
        .chat-messages {
            flex: 1; /* Takes up remaining space */
            overflow-y: auto; /* Scrollable content */
            padding: 10px;
            background-color: #f9f9f9; /* Light background for chat messages */
            border-radius: 8px;
            margin-bottom: 10px; /* Space between messages and input */
        }

        /* Styles for individual message 
        ./*sender_msg {
            background-color: #d1e7dd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            align-self: flex-end; 
            max-width: 70%; 
        }
        */

        .reciver_msg {
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px; /* Space between messages */
            align-self: flex-start; /* Align to the left */
            max-width: 70%; /* Limit the width of the message */
        }

        /* Styles for the input and button */
        .chat-input {
            display: flex;
            gap: 10px; /* Space between input and button */
        }

        #chat-message-input {
            flex: 1; /* Takes up remaining space */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        #send-button {
            padding: 10px 15px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #send-button:hover {
            background-color: #0056b3; /* Darker blue on hover */
        }
        .receiver_msg{
            background-color: #f1f0f0;
            padding: 10px;
            margin: 10px;
            border-radius: 10px;
            width: 50%;
            float: left;
        }
        .unread_message_block{
            background-color: #f1f0f0;
            padding: 10px;
            margin: 10px;
            border-radius: 10px;
            width: 50%;
            float: right;
        }
        .sender_msg{
            background-color: #f1f0f0;
            padding: 10px;
            margin: 10px;
            border-radius: 10px;
            width: 50%;
            float: right;
        }

        .receiver_msg {
        position: relative;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
        margin-bottom: 10px;
        }

        .senderNameBlock {
            cursor:pointer;
            font-weight: bold;
            color: #007bff; /* Blue color for the sender's name */
            background-color: #e9f5ff; /* Light blue background for highlighting */
            border: 1px solid #007bff; /* Border color matching the text */
            border-radius: 5px;
            padding: 5px 10px;
            margin-bottom: 10px; /* Space below the sender's name */
            font-size: 14px; /* Adjust font size as needed */
            position: absolute;
            top: -25px; /* Adjust positioning as needed */
            left: 10px;
            z-index: 1; /* Ensure it stays above other content */
        }

        div > div, div > span {
        margin-bottom: 5px;
        }

        .btn-info {
        margin-top: 5px;
        }

                
    </style>
</head>
<body>

    <div class="chat-container">
        <h1>{{group.name}}</h1>
        <h3 id="">Created on: 

            <script>
               // console.log("group is",'{{group}}');
                // Convert ISO 8601 date string to a formatted date
                function formatDate(isoDate) {
                    const date = new Date(isoDate);
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
                    const year = date.getFullYear();
                    return `${hours}:${minutes}:${seconds} ${day}/${month}/${year}`;
                }

                document.write(formatDate('{{group.created_at}}'));
            </script>
        </h3>

        <button onclick="openParticipantsModal()">View Participants</button>

        {% if request.user.id == group_admin %}
            Admin: You
            <button onclick="copyLink('{{group.id}}')">Copy group Link and invite friends</button>
        {% else %}
            Admin : {{group_admin_name}}
        {% endif %}

        <div id="snackbar"></div>
        <div id="downScrollButton" style="display:none;">
            <span id="countOfMsg"></span>
        </div>
        <div class="chat-messages">

            {% for i in group_chat_messages %}
                {% if i.id == unread_msg_start_id %}
                    <div id="unreadMessagesCount" class="unread_message_block">Unread Messages {{unread_msg_count}}</div>
                {% endif %}
                {% if i.sender == request.user.id %}
                    <div class="sender_msg" id="{{i.id}}">
                        {% if i.parent_message %}
                            <div style="background-color:#f2d9e6;border-radius:15px;height:70px;" id="{{i.parent_message.id}}" onclick="scrollAndHighlightMsg('{{i.parent_message.id}}')">
                                <div style="background-color:#b3cccc;border-radius:15px;">{{i.parent_message.sender_full_name}}</div>
                                <span>{{i.parent_message.message}}</span>
                            </div>
                        {% endif %}

                        
                        
                        <div>{{ i.message }} </div>
                        
                        <span>
                            <script>
                                // Convert ISO 8601 date string to a formatted date
                                function formatDate(isoDate) {
                                    const date = new Date(isoDate);
                                    const hours = String(date.getHours()).padStart(2, '0');
                                    const minutes = String(date.getMinutes()).padStart(2, '0');
                                    const seconds = String(date.getSeconds()).padStart(2, '0');
                                    const day = String(date.getDate()).padStart(2, '0');
                                    const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
                                    const year = date.getFullYear();
                                    return `${hours}:${minutes}:${seconds} ${day}/${month}/${year}`;
                                }
                
                                document.write(formatDate('{{ i.sent_time }}'));
                            </script>
                        </span>
                        <span>{{i.id}}</span>
                        <div><button class="btn btn-info" onclick="addDivtoChatBox('{{i.id}}')">Reply</button></div>
                      
                        <button onclick="openModal('{{i.id}}')">Info</button>
                        {% if i.is_read_by_all %}
                            <div id="status-{{i.id}}"><i class="fa-solid fa-circle-check"></i></div>
                        {% else %}
                            <div id="status-{{i.id}}"><i class="fa-regular fa-circle-check"></i></div>
                        {% endif %}

                    </div>
                {% else %}
                    <div class="receiver_msg" id="{{i.id}}">
                        <div class="senderNameBlock" onclick="window.location.href='/chats_page/{{i.sender}}/'">{{i.sender_name}}</div>
                        <div>{{ i.message }} </div>

                        <span>
                            <script>
                                // Convert ISO 8601 date string to a formatted date
                                function formatDate(isoDate) {
                                    const date = new Date(isoDate);
                                    const hours = String(date.getHours()).padStart(2, '0');
                                    const minutes = String(date.getMinutes()).padStart(2, '0');
                                    const seconds = String(date.getSeconds()).padStart(2, '0');
                                    const day = String(date.getDate()).padStart(2, '0');
                                    const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
                                    const year = date.getFullYear();
                                    return `${hours}:${minutes}:${seconds} ${day}/${month}/${year}`;
                                }
                
                                document.write(formatDate('{{ i.sent_time }}'));
                            </script>
                        </span>
                        <span>{{i.id}}</span>
                        <div><button onclick="addDivtoChatBox('{{i.id}}')" class="btn btn-info" >Reply</button></div>
                      
                    </div>
                {% endif %}
            {% endfor %}

        </div>

        <div class="modal fade" id="participantsModal" tabindex="-1" data-messageId="" aria-labelledby="participantsModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="participantsModalLabel">Info</h5>
                        <button type="button" class="btn-close" onclick="closeParticipantsModal()"></button>
                    </div>
                    <div class="modal-body">
                            <table style="display:none;">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Chat</th>
                                        <th>Action</th>
                                        <th>Joined At</th>
                                    </tr>
                                </thead>
                                <tbody id="participantsBody">
                                    <!-- Data rows will be added here -->
                                </tbody>
                            </table>

                        </table>
                    </div>
                </div>
            </div>
        </div>


        <div class="modal fade" id="infoModal" tabindex="-1" data-messageId="" aria-labelledby="infoModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="infoModalLabel">Info</h5>
                        <button type="button" class="btn-close" onclick="closeModal()"></button>
                    </div>
                    <div class="modal-body">
                       <div id="deliveredToMembers">
                        <table id="deliveredToMembersTable" style="display:none;">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Delivered At</th>
                                    <th>Read At</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data rows will be added here -->
                            </tbody>
                        </table>
                       </div>
                       <br/>
                       <div id="readBymembers">
                        <table id="readBymembersTable" style="display:none;">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Delivered At</th>
                                    <th>Read At</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data rows will be added here -->
                            </tbody>
                        </table>
                       </div>
                       <br/>
                       <div id="notDeliveredToMembers">
                        <table id="notDeliveredToMembersTable" style="display:none;">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Delivered At</th>
                                    <th>Read At</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data rows will be added here -->
                            </tbody>
                        </table>
                       </div>
                       
                    </div>
                </div>
            </div>
        </div>


        <div class="chat-input">
            <input type="text" id="chat-message-input" autocomplete="off" placeholder="Type your message...">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>




    
    <script>
        var upScrollingPageCount=0;
        var bottomScrollingPageCount=0;
        var groupMembersData=[];


        function closeParticipantsModal(){
            $("#participantsModal").modal('hide');
        }

 

        function openParticipantsModal(){
            
                getGroupMembers();
            
           
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString(); 
        }

        function deleteFromParticipantsTable(group_id, group_member_id){
            const row = document.querySelector(`#participantsBody tr[id="${group_member_id}"].participantsBlock`);
            console.log("row is",row);
            if(row){
                row.remove();
            }
        }

        function removeGroupMemberAPICall(group_id, group_member_id) {
             $.ajax({
                url: `/remove_group_member/${group_id}/${group_member_id}/`,
                type: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{csrf_token}}'
                },
                success: function(result) {
                  if(result.Error=="NA"){
                    toastr.error("Participant Removed Successfully", "Success", {
                        "positionClass": "toast-top-right"
                    });
                    deleteFromParticipantsTable(group_id, group_member_id);
                  }
                  else{
                    toastr.error(result.Error, "Error", {
                        "positionClass": "toast-top-right"
                    });
                    return;

                  }
                },
                error: function(xhr, status, error) {
                    // Handle error
                    console.error('Error removing member:', status, error);
                }
            }); 
        }

        function deleteParticipant(id){
            //id is group member id to be removed
            removeGroupMemberAPICall('{{group.id}}',id);
        }

        function populateParticipantsTable(groupMemData){
            const tbody = document.getElementById('participantsBody');
            groupMemData.forEach(function(participant) {
                const row = document.createElement('tr');
                row.setAttribute('id',participant.user);
                row.classList.add('participantsBlock');

                const nameCell = document.createElement('td');
                nameCell.textContent = `${participant.group_member_name}${participant.user=='{{request.user.id}}' ? ' (You)' : ''}`; 
                row.appendChild(nameCell);

                const messageCell = document.createElement('td');
                const messageButton=document.createElement('button');
                messageButton.textContent='Chat'
                messageButton.onclick=function(){
                    window.location.href=`/chats_page/${participant.user}`;
                }
                messageCell.appendChild(messageButton);
                row.appendChild(messageCell);

                
                const removeCell = document.createElement('td');
                const removeButton=document.createElement('button');
                removeButton.textContent='Remove Participant'
                removeButton.disabled=true;
                if('{{request.user.id}}'=='{{group_admin}}' && participant.user!='{{request.user.id}}'){
                    removeButton.disabled=false;
                }
                removeButton.onclick=function(){
                    deleteParticipant(`${participant.user}`);
                }
                removeCell.appendChild(removeButton);
                row.appendChild(removeCell);

                const joinedAtCell = document.createElement('td');
                joinedAtCell.textContent = formatDate(participant.joined_at);
                row.appendChild(joinedAtCell);

                

                tbody.appendChild(row);
            });

            document.querySelector('table').style.display = 'table';
        }

        function getGroupMembers(){
            let groupId='{{group.id}}';
            fetch(`/get_group_members/${groupId}/`, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if(data.Error=="NA"){
                    let members=data.Status;
                    groupMembersData.push(...members);
                     populateParticipantsTable(members);
                     $("#participantsModal").modal('show');
                }
                else{
                    console.log("Error in fetching group members");
                }
            })
            .catch(error => {
                console.error('Error fetching group members:', error)
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const element = document.querySelector('.chat-messages');
            const unreadMessagesElement = document.getElementById('unreadMessagesCount');
            if(unreadMessagesElement){
                const elementRect = element.getBoundingClientRect();
                const unreadMessagesRect = unreadMessagesElement.getBoundingClientRect();
                const scrollPosition = unreadMessagesRect.top - elementRect.top + element.scrollTop;
                element.scrollTop = scrollPosition;
            }
            else{
                element.scrollTop = element.scrollHeight;
            }
           
        });

        function closeModal(){
            $("#infoModal").modal('hide');
            $("#infoModal").attr('data-messageId',"");
        }

        function openModal(messageId){
            // this will fetch the messages read or not read statuses and display in modal.
            let groupId='{{group.id}}';
            console.log("isnide openModal",messageId);
            fetch(`/get_read_statuses/${groupId}/${messageId}/`, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if(data.Error=="NA"){
                    let statusOfMessages=data.Status;
                   
                    let readBymembersDiv=document.querySelector('#readBymembersTable tbody');
                    let deliveredToMembersDiv=document.querySelector('#deliveredToMembersTable tbody');
                    let notDeliveredToMembersDiv=document.querySelector('#notDeliveredToMembersTable tbody');
                    //we need to clear previous data populated in table.
                    ['readBymembersTable', 'deliveredToMembersTable', 'notDeliveredToMembersTable'].forEach(id => document.querySelector(`#${id} tbody`).innerHTML = '');

                    statusOfMessages.forEach((item)=>{
                        if (item.read_at && item.delivered_at){
                            let tr=document.createElement('tr');
                            tr.setAttribute('id',item.member_id);
                            tr.innerHTML=`<td>${item.member_full_name}</td><td>${item.delivered_at}</td><td>${item.read_at}</td>`;
                            readBymembersDiv.appendChild(tr);
                            $("#readBymembersTable").show();
                        }
                        else if(item.delivered_at && !item.read){
                            let tr=document.createElement('tr');
                            tr.setAttribute('id',item.member_id);
                            tr.innerHTML=`<td>${item.member_full_name}</td><td>${item.delivered_at}</td><td>Not Read</td>`;
                            deliveredToMembersDiv.appendChild(tr);
                            $("#deliveredToMembersTable").show();
                        }
                        else{
                            let tr=document.createElement('tr');
                            tr.setAttribute('id',item.member_id);
                            tr.innerHTML=`<td>${item.member_full_name}</td><td>Not Delivered</td><td>Not Read</td>`;
                            notDeliveredToMembersDiv.appendChild(tr);
                            $("#notDeliveredToMembersTable").show();
                        }
                    })

                    $("#infoModal").modal('show');
                    $("#infoModal").attr('data-messageId',messageId);
                    hideTables();
                    
                }
                else{
                    showSnackbar("No more messages to show",'F');
                    $("#infoModal").attr('data-messageId',"");
                }
            })
            .catch(error => {
                $("#infoModal").attr('data-messageId',"");
                console.error('Error fetching previous messages:', error)
            });

        }  
        
     
        function scrollAndHighlightMsg(messageIdToHighlight){
            const targetDiv = document.getElementById(messageIdToHighlight);
            if (targetDiv) {
                targetDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                targetDiv.style.backgroundColor = '#90bcd4';
                setTimeout(() => {
                    targetDiv.style.backgroundColor = '';
                }, 5000);
            } else {
                loadPreviousMessages().then(() => {
                    scrollAndHighlightMsg(messageIdToHighlight);
                });
            }
        }

        function addDivtoChatBox(id){
            var messageContent = document.getElementById(id);
            var chatMessageInput = document.getElementById('chat-message-input');
            if (messageContent && chatMessageInput) {
                var parent = chatMessageInput.parentNode;
                
                parent.insertBefore(messageContent, chatMessageInput);
            }
            
        }

        function formatDate(isoDate) {
            const date = new Date(isoDate);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); 
            const year = date.getFullYear();
            return `${hours}:${minutes}:${seconds} ${day}/${month}/${year}`;
        }

        function moveDivAbove(originalDivId, targetDivId) {
            var originalDiv = document.getElementById(originalDivId);
            var targetDiv = document.getElementById(targetDivId);
        
            if (originalDiv && targetDiv) {
                var parent = targetDiv.parentNode;
                parent.insertBefore(originalDiv, targetDiv);
            }
        }
        function deleteChatMessage(){
            
        }

        function showDownScrollButton() {
            const downScrollButton = document.getElementById('downScrollButton');
            const countOfMsg = document.getElementById('countOfMsg');
            const unreadMessagesElement = document.getElementById('unreadMessagesCount');
        
            if (downScrollButton) {
                downScrollButton.style.display = 'block'; 
        
                downScrollButton.firstChild.textContent = 'New Messages';
        
                const unreadMessagesCount = unreadMessagesElement ? parseInt(unreadMessagesElement.textContent.split("Unread Messages ")[1], 10) : 0;
        
                console.log("Unread messages count 676543:", unreadMessagesCount);
        
                $("#countOfMsg").text(unreadMessagesCount);

                $("#downScrollButton").on('click', function() {
                    const unreadMessagesElement = document.getElementById('unreadMessagesCount');
                    var chatMessagesContainer = document.querySelector('.chat-messages');
                 
                    if (unreadMessagesElement && chatMessagesContainer) {
                        unreadMessagesElement.scrollIntoView({
                            behavior: 'smooth', 
                            block: 'nearest',   
                            inline: 'nearest'   
                        });
                    }
                    $(this).hide(); 
                    $("#countOfMsg").text(''); 
                });
            }
        }
    
        function createMessageDiv(messageText, isoDate,className,replyToMessageId,replyToMessageVal,messageID,isRead,senderName) {
            
            var divSenderMsg = document.createElement('div');
            divSenderMsg.classList.add(className);
            divSenderMsg.id = messageID;
            var divMessage = document.createElement('div');
            divMessage.textContent = messageText;
            var spanDate = document.createElement('span');
            spanDate.textContent = formatDate(isoDate);
            var infoButton = document.createElement('button');
            infoButton.textContent = 'Info';
            infoButton.onclick=function(){
                openModal(messageID);
            }
            var replyButtonDiv=document.createElement('div');
            replyButtonDiv.innerHTML = `<button class="btn btn-info" onclick="addDivtoChatBox('${messageID}')">Reply</button><button style="del-btn" onclick="deleteChatMessage()">Delete</button>`;
    
            if(replyToMessageId){
                var replyToDiv = document.createElement('div');
                replyToDiv.style.backgroundColor = '#f2d9e6';
                replyToDiv.style.borderRadius = '15px';
                replyToDiv.style.height = '70px';
                replyToDiv.id = replyToMessageId;
                replyToDiv.setAttribute('onclick', `scrollAndHighlightMsg('${replyToMessageId}')`);
            
                var innerDiv = document.createElement('div');
                innerDiv.style.backgroundColor = '#b3cccc';
                innerDiv.style.borderRadius = '15px';
                innerDiv.textContent = 'test';
            
                var span = document.createElement('span');
                span.textContent = replyToMessageVal;
            
                replyToDiv.appendChild(innerDiv);
                replyToDiv.appendChild(span);
            
                divSenderMsg.appendChild(replyToDiv);
            }
            divSenderMsg.appendChild(divMessage);
            divSenderMsg.appendChild(spanDate);
            divSenderMsg.appendChild(replyButtonDiv);
            divSenderMsg.appendChild(infoButton);

            var divOfReadStatus = document.createElement('div');
            divOfReadStatus.innerHTML = isRead ? `<i class="fa-solid fa-circle-check"></i>` : `<i class="fa-regular fa-circle-check">`;
            divSenderMsg.appendChild(divOfReadStatus);
         
            document.querySelector('.chat-messages').appendChild(divSenderMsg);
           

            const allDivs = document.querySelectorAll('.chat-messages div.receiver_msg, .chat-messages div.sender_msg');
            let currentDivId = null;
        
            for (const div of allDivs) {
                const rect = div.getBoundingClientRect();
                if (rect.top >= 0 && rect.top < (window.innerHeight || document.documentElement.clientHeight)) {
                    currentDivId = div.id;
                    break; 
                }
            }

            if(className=="receiver_msg"){
                console.log("currentDivId is",currentDivId);
                const distance = Math.abs(divSenderMsg.getBoundingClientRect().top - document.getElementById(currentDivId)?.getBoundingClientRect().top);
                console.log("distance is",distance);
                if(distance>=500){
                    showDownScrollButton();

                }
            }
            //disableScrollToBottom=false;
        }
    </script>

    <script>
        function copyLink(groupId){
            let textToCopy = `Click on this link to join the group ${window.location.origin}/join_group/${groupId}/`;

            const tempTextarea = document.createElement('textarea');
            document.body.appendChild(tempTextarea);

            tempTextarea.value = textToCopy;

            tempTextarea.select();

            document.execCommand('copy');

            document.body.removeChild(tempTextarea);

            Toastify({
                text: "Link copied to clipboard!",
                duration: 3000, // Duration in milliseconds
                gravity: "bottom", // `top` or `bottom`
                position: "center", // `left`, `center`, or `right`
                stopOnFocus: true, // Prevents dismissing of toast on hover
                style: {
                    background: "#333", // Background color using the new property
                }
            }).showToast();

        }
    </script>


<script>
    let isFetching = false;
    var disableScrollToBottom=false;
    setTimeout(()=>{
        console.log("INSIDE SETTIMEOUT");
        const receiverMsgCount = document.querySelectorAll('#chat-messages #receiver_msg').length;
        const senderMsgCount = document.querySelectorAll('#chat-messages #sender_msg').length;
        const unreadMessagesElement = document.getElementById('unreadMessagesCount');
        if( (receiverMsgCount+senderMsgCount<10) && unreadMessagesElement){
            console.log("inside <10 condition CALLING THE ONSCROLLBOTTOM");
            onScrollToBottom();



        }


    },8000)

        let lastFetchTime = 0;
        var chatSocket;
        const fetchThrottle = 600; // Minimum time between fetches in milliseconds

           
        $(document).ready(function(){
            var senderId = {{ request.user.id }};  
            var groupId={{group.id}} 
            chatSocket = new WebSocket(
                'ws://' + window.location.host + '/group_chat/' + groupId + '/'
            );

            chatSocket.onopen = function(e) {
                console.log("WebSocket connection opened.");
            };

            chatSocket.onmessage = function(e) {
                var data = JSON.parse(e.data);
                if(data.event_name=="chat_message"){
                    if(data.sender_id!={{request.user.id}}){
                        const unreadMessagesElement = document.getElementById('unreadMessagesCount');
                        const unreadMessagesCount = unreadMessagesElement ? parseInt(unreadMessagesElement.textContent.split("Unread Messages")[1], 10) : 0;
                
                        console.log("Unread messages count:", unreadMessagesCount);
                        //disableScrollToBottom=true;
                        if(unreadMessagesElement){
                            $("#unreadMessagesCount").text('Unread Messages '+ (unreadMessagesCount+1).toString());
                        }
                        else{
                            const bottomElement = document.querySelector('.chat-messages div.sender_msg:last-of-type, .chat-messages div.receiver_msg:last-of-type');
                            if (bottomElement) {
                                const unreadMessagesDiv = document.createElement('div');
                                unreadMessagesDiv.id = 'unreadMessagesCount';
                                unreadMessagesDiv.className = 'unread_message_block';
                                unreadMessagesDiv.textContent = 'Unread Messages 1';

                                bottomElement.insertAdjacentElement('afterend', unreadMessagesDiv);
                                //we need to add event listener after creating an element of unrreadMessagesDiv
                                {% comment %} const chatMessagesElement = document.querySelector('.chat-messages');

                                chatMessagesElement.addEventListener('scroll', onScrollToBottom); {% endcomment %}
                            }                           
                        }
                

                        createMessageDiv(data.message, new Date().toISOString(),'receiver_msg',data.reply_to_message_id,data.reply_to_message_val,data.message_id,data.is_read,data.sender_name);
                    }
                    else{
                        createMessageDiv(data.message, new Date().toISOString(),'sender_msg',data.reply_to_message_id,data.reply_to_message_val,data.message_id,data.is_read,data.sender_name);
                    }
                }
                else if(data.event_name=="status"){
                    if(data.user_id==receiverId){
                        if(data.is_online){
                            $("#userStatus").text('Online');
                        }
                        else{
                            $("#userStatus").text('Offline');
                        }
                            
                    }
                    
                    
                }
                else if(data.event_name=="msg_read"){
                    let messageIds=data.message_ids;
                    let readHtml = `
                    <svg class="svg-inline--fa fa-circle-check" aria-hidden="true" focusable="false"
                        data-prefix="fas" data-icon="circle-check" role="img" xmlns="http://www.w3.org/2000/svg" 
                        viewBox="0 0 512 512" data-fa-i2svg="">
                        <path fill="currentColor" 
                            d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z">
                        </path>
                    </svg><!-- <i class="fa-solid fa-circle-check"></i> Font Awesome fontawesome.com -->`;

                    messageIds.forEach((item)=>{
                        document.getElementById(`status-${item}`).innerHTML = readHtml;
                    })

                }

                else if(data.event_name=='message_read_by_user_in_group'){
                    const isOpen = $('#infoModal').hasClass('show');
                   
                    if(isOpen){
                        let messageId= JSON.parse(data.message_id.replace(/'/g, '"'));
                        console.log("messageId",messageId,typeof(messageId));
                        let read_at=data.read_at;
                        let messageIdOfModal=$("#infoModal").attr("data-messageId");
                        console.log("messageIdOfModal",messageIdOfModal);
                        messageId.forEach((item)=>{

                            if(item==messageIdOfModal){


                                const row = document.querySelector(`#notDeliveredToMembersTable tbody tr[id='${data.sender_id}']`);
                                console.log("row",row);
                                let deliveredDate;
                                const deliveredRow=document.querySelector(`#deliveredToMembersTable tbody tr[id='${data.sender_id}']`);
                                console.log("deliveredRow",deliveredRow);
                                if(row){
                                    deliveredDate = row ? row.querySelector('td:nth-child(2)').textContent : 'Not Delivered';
                                    row.remove();
                                }
                                if(deliveredRow){
                                    deliveredDate = deliveredRow ? deliveredRow.querySelector('td:nth-child(2)').textContent : 'Not Delivered';
                                    deliveredRow.remove();
                                }

                                const row2 = document.querySelector(`#readBymembers tbody tr[id='${data.sender_id}']`);
                                if(!row2){
                                    let tableId='readBymembers';
                                    let tr=document.createElement('tr');
                                    tr.setAttribute('id',item);
                                    tr.innerHTML=`<td>${data.sender_name}</td><td>${deliveredDate}</td><td>${data.read_at}</td>`;
                                    document.querySelector(`#${tableId} tbody`).appendChild(tr);
                                    $("#readBymembersTable").css('display','block');
                                    hideTables();
                            

                                }

                            }
                        
                        })
                        $("#readBymembers").show();

                    }
                }
                else{
                    console.log("data",data);
                }
               
            };

            chatSocket.onclose = function(e) {
                console.log("WebSocket connection closed.");
            };

            chatSocket.onerror = function(e) {
                console.log("WebSocket error: ", e);
            };

            $('#send-button').click(function() {
                var messageInputDom = $('#chat-message-input');
                var message = messageInputDom.val();
                var chatInputDiv = document.querySelector('.chat-messages');
                var replyToMessageId="";

                if (chatInputDiv) {
                    var messages = chatInputDiv.querySelectorAll('.sender_msg, .receiver_msg');
                    console.log("messages",messages);
                    
                    if (messages.length > 0) {
                        //debugger;
                        messages.forEach(function(div) {
                            if(div.id){
                                replyToMessageId = div.id;  
                                console.log("replyToMessageId",replyToMessageId);
                            }
                        });
                    } else {
                        console.log('There are no receiver_message or sender_message divs inside chat-input');
                    }
                }

                chatSocket.send(JSON.stringify({
                    'message': message,
                    'replyToMessageId':replyToMessageId
                }));
                

                messageInputDom.val('');
                Array.from(document.querySelector('.chat-input').children).filter(child => child.classList.contains('sender_msg')).forEach(child => child.remove());
                Array.from(document.querySelector('.chat-input').children).filter(child => child.classList.contains('receiver_msg')).forEach(child => child.remove());
            });

            $('#chat-message-input').on('keypress', function(e) {
                if (e.which === 13) {
                    $('#send-button').click();
                }
            });
        });


    
        function onScrollToBottom() {
            console.log("inside onScrollToBottom-------------");
            {% comment %} if(disableScrollToBottom){
                return;
            } {% endcomment %}
            if(chatSocket.readyState !== WebSocket.OPEN){
                return;
            }
            const chatMessagesElement = document.querySelector('.chat-messages');
            const scrollHeight = chatMessagesElement.scrollHeight;
            const scrollTop = chatMessagesElement.scrollTop;
            const clientHeight = chatMessagesElement.clientHeight;
    
            console.log("Scroll check -> scrollHeight:", scrollHeight, "scrollTop:", scrollTop, "clientHeight:", clientHeight);
    
            if (scrollHeight - scrollTop <= clientHeight + 1) {
                // Check throttle
                const now = Date.now();
                if (now - lastFetchTime < fetchThrottle) {
                    return; // Prevent fetching too frequently
                }
    
                if (!isFetching) {
                    isFetching = true;
                    lastFetchTime = now;

                    const bottomElementId = document.querySelector('.chat-messages div.sender_msg:last-of-type, .chat-messages div.receiver_msg:last-of-type').getAttribute('id');
                    fetchMoreUnreadMessages(bottomElementId);
                }
            }
        }

        function fetchMoreUnreadMessages(bottomElementId) {
            sendForMarkMessagesRead(bottomElementId)
            console.log("fetchMoreUnreadMessages called with bottomElementId:", bottomElementId);
    
            let senderId = {{request.user.id}};
            let groupId = '{{group.id}}';
            bottomScrollingPageCount += 1;
    
            fetch(`/get_next_group_chats_messages/${groupId}/${bottomScrollingPageCount}/${bottomElementId}`, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                console.log("Data received:", data);
                if (data.Error === "NA") {
                    let messagesData = data.page_messages;
                    if (messagesData.length === 0) {
                        bottomScrollingPageCount -= 1;
                    }
                    messagesData.forEach(message => {
                        let className = message.sender === senderId ? 'sender_msg' : 'receiver_msg';
                        console.log("Prepending message with ID:", message.id);
                        appendChatMessageToBottom(message.message, message.sent_time, message.id, className, message.is_read, message.sender_name,message.sender);
                    });
                } else {
                    bottomScrollingPageCount -= 1;
                    console.log("No more messages to show.");
                    showSnackbar("No more messages to show", 'F');
                }
                isFetching = false;
            })
            .catch(error => {
                console.error('Error fetching previous messages:', error);
                bottomScrollingPageCount -= 1;
                isFetching = false;
            });
        }


        function appendChatMessageToBottom(messageText, isoDate,id,className,isRead,senderName,senderId) {
            var divSenderMsg = document.createElement('div');
            divSenderMsg.classList.add(className);
            divSenderMsg.id=id;
            
            var divMessage = document.createElement('div');
            divMessage.textContent = messageText;
            var spanDate = document.createElement('span');
            spanDate.textContent = formatDate(isoDate);
            var spanID = document.createElement('span');
            spanID.textContent = "ID is"+id;

            if(className=='receiver_msg'){
                var divSenderName=document.createElement('div');
                divSenderName.classList.add('senderNameBlock')
                divSenderName.textContent=senderName;
                divSenderName.onclick=function(){
                    window.location.href='/chats_page/'+senderId+'/';
                }
                divSenderMsg.appendChild(divSenderName);
            }
            
            divSenderMsg.appendChild(divMessage);
            divSenderMsg.appendChild(spanDate);
            divSenderMsg.appendChild(spanID);
            var divOfReply = document.createElement('div');
            divOfReply.innerHTML = `<button onclick="addDivtoChatBox('${id}')" class="btn btn-info" >Reply</button>`;
            var divOfReadStatus = document.createElement('div');
            divOfReadStatus.innerHTML = isRead ? `<i class="fa-solid fa-circle-check"></i>` : `<i class="fa-regular fa-circle-check">`;
            divSenderMsg.appendChild(divOfReply);
            divSenderMsg.appendChild(divOfReadStatus);
            chatMessagesContainer.appendChild(divSenderMsg);
        }
    
        $(document).ready(function() {
            const chatMessagesElement = document.querySelector('.chat-messages');
            const unreadMessagesElement = document.getElementById('unreadMessagesCount');
            const unreadMessagesCount = unreadMessagesElement ? parseInt(unreadMessagesElement.textContent.split("Unread Messages")[1], 10) : 0;
            chatMessagesElement.addEventListener('scroll', onScrollToBottom);
            //console.log("Unread messages count:", unreadMessagesCount);
    
            if (unreadMessagesCount) {
                
    
                if (unreadMessagesElement) {
                    
                    const elementRect = chatMessagesElement.getBoundingClientRect();
                    const unreadMessagesRect = unreadMessagesElement.getBoundingClientRect();
                    const scrollPosition = unreadMessagesRect.top - elementRect.top + chatMessagesElement.scrollTop;
                    chatMessagesElement.scrollTop = scrollPosition;
                } else {
                    
                    chatMessagesElement.scrollTop = chatMessagesElement.scrollHeight;
                }
            }
        });
    
</script>

     <script>
        
        function sendForMarkMessagesRead(bottomElementId){
            // Get all elements with class 'sender_msg' inside the 'chat-messages' container
            const chatMessages = document.querySelector('.chat-messages');
            const senderMessages = [];
            let messageIds=[];
            const unreadMessagesElement = document.getElementById('unreadMessagesCount');
            if(unreadMessagesElement){
                const unreadMessagesCount = unreadMessagesElement ? parseInt(unreadMessagesElement.textContent.split("Unread Messages")[1], 10) : 0;
                
                let nextSibling = unreadMessagesElement.nextElementSibling;

                while (nextSibling) {
                    if (nextSibling.classList.contains('receiver_msg')) {
                        senderMessages.push(nextSibling);
                    }
                    nextSibling = nextSibling.nextElementSibling;
                }

                // Now 'senderMessages' array contains all the 'sender_msg' elements after 'unreadMessagesCount'
                console.log(senderMessages);
                if (senderMessages){
                    senderMessages.forEach((i)=>{

                        messageIds.push(i.id)
                    })

                    if(messageIds.length>0){
                        chatSocket.send(JSON.stringify({
                            'messageIds': messageIds,
                            'type_of_event':'markMessageRead'
                        }));
                    }

                    if(messageIds.length==unreadMessagesCount){
                        $("#unreadMessagesCount").remove();
                    }

                }

            }
          
        }

        function hideTables() {
            let isEmpty;
            
            isEmpty = document.querySelector('#deliveredToMembersTable tbody').children.length === 0;
            if (isEmpty) {
                $("#deliveredToMembersTable").css('display', 'none');
            }
            
            isEmpty = document.querySelector('#readBymembersTable tbody').children.length === 0;
            if (isEmpty) {
                $("#readBymembersTable").css('display', 'none');
            }
            
            isEmpty = document.querySelector('#notDeliveredToMembersTable tbody').children.length === 0;
            if (isEmpty) {
                $("#notDeliveredToMembersTable").css('display', 'none');
            }
        }
     

    </script>

    <script>
        
        function showSnackbar(message,status){
                    
            var snackbar = document.getElementById("snackbar");
            snackbar.textContent = message;
            snackbar.style.display = "block";
            snackbar.style.backgroundColor =status=='S'?"#d1e7dd":"#f8d7da";
            snackbar.style.color =status=='S'?"#0f5132":"#842029";
            snackbar.style.borderColor =status=='S'?"#badbcc":"#f5c2c7";
        
                setTimeout(function() {
                    snackbar.style.display = "none";
                }, 6000); 
            
        }


        var chatMessagesContainer = document.querySelector('.chat-messages');
            chatMessagesContainer.addEventListener('scroll', function() {
                if (chatMessagesContainer.scrollTop === 0) {
                    const topElement=document.querySelector('.chat-messages div.sender_msg, .chat-messages div.receiver_msg');
                    const topElementId = document.querySelector('.chat-messages div.sender_msg, .chat-messages div.receiver_msg')?.getAttribute('id');
                    console.log("topElementId",topElementId);
                    loadPreviousMessages(topElementId,topElement);
                }
            });

            function loadPreviousMessages(lastMessageId,topElement) {
                let senderId={{request.user.id}};
                let groupId='{{group.id}}';
                upScrollingPageCount+=1;
                fetch(`/get_previous_group_chats_messages/${groupId}/${upScrollingPageCount}/${lastMessageId}`, {
                    method: 'GET'
                })
                .then(response => response.json())
                .then(data => {
                    if(data.Error=="NA"){
                        let messagesData=data.page_messages;
                        if(messagesData.length==0){
                            upScrollingPageCount-=1;
                        }
                        messagesData.forEach(message => {
                            let className=message.sender==senderId?'sender_msg':'receiver_msg';
                            prependMessageDiv(message.message, message.sent_time,message.id,className,message.is_read,message.sender_name,topElement,message.sender);
                        });
                        {% comment %} if (topElement) {
                            topElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        } {% endcomment %}
                    }
                    else{
                        upScrollingPageCount-=1;
                        showSnackbar("No more messages to show",'F');
                    }
                })
                .catch(error => console.error('Error fetching previous messages:', error));
            }

            function showReplyMessage(replyContent, repliedMessageID) {
                const chatContainer = document.getElementById('chat-container');
                const repliedMessage = document.querySelector(`[id="${repliedMessageID}"]`);
        
                const replyMsgDiv = document.createElement('div');
                replyMsgDiv.className = 'message reply_msg';
                replyMsgDiv.innerHTML = `
                    <div>
                        <a href="#${repliedMessageID}">Replied to: ${repliedMessage.innerHTML}</a>
                    </div>
                    <div>${replyContent}</div>
                    <span>${new Date().toLocaleTimeString()} ${new Date().toLocaleDateString()}</span>
                `;
        
                chatContainer.appendChild(replyMsgDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        
            function prependMessageDiv(messageText, isoDate,id,className,isRead,senderName,topElement,senderId) {
                var divSenderMsg = document.createElement('div');
                divSenderMsg.classList.add(className);
                divSenderMsg.id=id;
                
                var divMessage = document.createElement('div');
                divMessage.textContent = messageText;
                var spanDate = document.createElement('span');
                spanDate.textContent = formatDate(isoDate);
                var spanID = document.createElement('span');
                spanID.textContent = "ID is"+id;

                if(className=='receiver_msg'){
                    var divSenderName=document.createElement('div');
                    divSenderName.classList.add('senderNameBlock')
                    divSenderName.textContent=senderName;
                    divSenderName.onclick=function(){
                        window.location.href='/chats_page/'+senderId+'/';
                    }
                    divSenderMsg.appendChild(divSenderName);
                }
                
                divSenderMsg.appendChild(divMessage);
                divSenderMsg.appendChild(spanDate);
                divSenderMsg.appendChild(spanID);
                var divOfReply = document.createElement('div');
                divOfReply.innerHTML = `<button onclick="addDivtoChatBox('${id}')" class="btn btn-info" >Reply</button>`;
                var divOfReadStatus = document.createElement('div');
                divOfReadStatus.innerHTML = isRead ? `<i class="fa-solid fa-circle-check"></i>` : `<i class="fa-regular fa-circle-check">`;
                divSenderMsg.appendChild(divOfReply);
                divSenderMsg.appendChild(divOfReadStatus);
                chatMessagesContainer.insertBefore(divSenderMsg, chatMessagesContainer.firstChild);
            }

          

    </script>

</body>
</html>